---
# ===================================
# Rôle Ansible : docker_server
# Installation de Docker sur Ubuntu 20.04
# ===================================

# Ce fichier contient toutes les tâches pour installer Docker
# de manière automatisée et idempotente (rejouable sans problème)

# =============================
# Étape 1 : Mise à jour du cache APT
# =============================
- name: Mettre à jour le cache APT
  ansible.builtin.apt:
    update_cache: yes
    cache_valid_time: 3600  # Cache valide 1h pour éviter des updates inutiles
  become: yes
  # become: yes = exécuter avec sudo (requis pour apt)

# =============================
# Étape 2 : Installation des prérequis
# =============================
- name: Installer les packages prérequis pour Docker
  ansible.builtin.apt:
    name:
      - ca-certificates        # Certificats SSL pour HTTPS
      - curl                   # Télécharger des fichiers
      - gnupg                  # Vérifier les signatures GPG
      - lsb-release           # Informations sur la distribution
    state: present
  become: yes
  # state: present = installer si pas déjà présent (idempotent)

# =============================
# Étape 3 : Ajouter la clé GPG officielle de Docker
# =============================
- name: Créer le répertoire pour les clés APT
  ansible.builtin.file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'
  become: yes
  # Crée /etc/apt/keyrings si n'existe pas déjà

- name: Télécharger et ajouter la clé GPG de Docker
  ansible.builtin.shell: |
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
    chmod a+r /etc/apt/keyrings/docker.gpg
  args:
    creates: /etc/apt/keyrings/docker.gpg
  become: yes
  # creates: ne s'exécute que si le fichier n'existe pas (idempotence)

# =============================
# Étape 4 : Ajouter le dépôt officiel Docker
# =============================
- name: Ajouter le dépôt Docker aux sources APT
  ansible.builtin.shell: |
    echo \
      "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
      $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
  args:
    creates: /etc/apt/sources.list.d/docker.list
  become: yes
  # Ajoute le dépôt officiel Docker (pas celui d'Ubuntu qui est obsolète)

# =============================
# Étape 5 : Mettre à jour le cache APT avec le nouveau dépôt
# =============================
- name: Mettre à jour le cache APT après ajout du dépôt Docker
  ansible.builtin.apt:
    update_cache: yes
  become: yes
  # Nécessaire pour que APT connaisse les packages du dépôt Docker

# =============================
# Étape 6 : Installer Docker Engine
# =============================
- name: Installer Docker Engine et ses composants
  ansible.builtin.apt:
    name:
      - docker-ce              # Docker Community Edition (moteur principal)
      - docker-ce-cli          # Interface en ligne de commande
      - containerd.io          # Runtime de conteneurs
      - docker-buildx-plugin   # Plugin pour builds multi-architectures
      - docker-compose-plugin  # Plugin docker compose (v2)
    state: present
  become: yes
  # Installe Docker + docker compose en tant que plugin

# =============================
# Étape 7 : Démarrer et activer le service Docker
# =============================
- name: Démarrer le service Docker
  ansible.builtin.service:
    name: docker
    state: started
    enabled: yes
  become: yes
  # state: started = démarre Docker maintenant
  # enabled: yes = démarre Docker automatiquement au boot

# =============================
# Étape 8 : Ajouter l'utilisateur au groupe docker
# =============================
- name: Ajouter l'utilisateur ubuntu au groupe docker
  ansible.builtin.user:
    name: "{{ ansible_user }}"  # ansible_user = utilisateur de connexion SSH
    groups: docker
    append: yes
  become: yes
  # append: yes = ajoute au groupe sans retirer des autres groupes
  # Permet d'utiliser docker sans sudo

# =============================
# Étape 9 : Vérifier l'installation de Docker
# =============================
- name: Vérifier la version de Docker installée
  ansible.builtin.command: docker --version
  register: docker_version
  changed_when: false
  # register: enregistre le résultat pour l'afficher après
  # changed_when: false = cette commande ne change rien sur le système

- name: Afficher la version de Docker
  ansible.builtin.debug:
    msg: "✅ Docker installé : {{ docker_version.stdout }}"

# =============================
# Étape 10 : Vérifier l'installation de docker compose
# =============================
- name: Vérifier la version de docker compose
  ansible.builtin.command: docker compose version
  register: compose_version
  changed_when: false

- name: Afficher la version de docker compose
  ansible.builtin.debug:
    msg: "✅ Docker Compose installé : {{ compose_version.stdout }}"

# =============================
# Étape 11 : Test fonctionnel avec hello-world
# =============================
- name: Tester Docker avec l'image hello-world
  ansible.builtin.command: docker run --rm hello-world
  register: hello_world
  changed_when: false
  become: yes
  # Test que Docker peut télécharger et exécuter une image

- name: Afficher le résultat du test hello-world
  ansible.builtin.debug:
    msg: "✅ Docker fonctionne correctement"
  when: "'Hello from Docker!' in hello_world.stdout"

# =============================
# Étape 12 : Création du répertoire de déploiement
# =============================
- name: Créer le répertoire /opt/cloud1
  ansible.builtin.file:
    path: /opt/cloud1
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0755'
  become: yes
  # Ce dossier contiendra docker-compose.yml, .env et nginx.conf
  # owner/group: appartient à l'utilisateur SSH (ubuntu)
  # mode 0755: lecture/écriture pour le propriétaire, lecture pour les autres

# =============================
# Étape 13 : Copie de docker-compose.yml
# =============================
- name: Copier docker-compose.yml vers le serveur
  ansible.builtin.copy:
    src: ../../../docker-compose.yml
    dest: /opt/cloud1/docker-compose.yml
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0644'
  # src: chemin relatif depuis le rôle vers la racine du projet
  # dest: destination sur le serveur distant
  # mode 0644: lecture/écriture propriétaire, lecture pour les autres

# =============================
# Étape 14 : Copie du fichier .env
# =============================
- name: Copier le fichier .env vers le serveur
  ansible.builtin.copy:
    src: ../../../.env
    dest: /opt/cloud1/.env
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0600'
  # mode 0600: lecture/écriture UNIQUEMENT pour le propriétaire (sécurité)
  # Fichier sensible contenant les mots de passe

# =============================
# Étape 15 : Création du répertoire nginx
# =============================
- name: Créer le répertoire /opt/cloud1/nginx
  ansible.builtin.file:
    path: /opt/cloud1/nginx
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0755'
  # Dossier pour la configuration Nginx

# =============================
# Étape 16 : Copie de la configuration Nginx
# =============================
- name: Copier nginx.conf vers le serveur
  ansible.builtin.copy:
    src: ../../../nginx/nginx.conf
    dest: /opt/cloud1/nginx/nginx.conf
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0644'
  # Configuration du reverse proxy Nginx

# =============================
# Étape 17 : Démarrage de la stack Docker
# =============================
- name: Lancer docker compose up -d
  ansible.builtin.shell: docker compose up -d
  args:
    chdir: /opt/cloud1
  become: yes
  register: docker_compose_output
  # args.chdir: se place dans /opt/cloud1 avant d'exécuter la commande
  # docker compose up -d: lancer la stack en arrière-plan
  # become: yes: nécessaire pour docker (même si utilisateur dans groupe docker)

# =============================
# Étape 18 : Afficher le résultat du déploiement
# =============================
- name: Afficher le résultat de docker compose
  ansible.builtin.debug:
    msg: "✅ Stack WordPress déployée avec succès"

# =============================
# Étape 19 : Vérifier que les conteneurs tournent
# =============================
- name: Lister les conteneurs Docker en cours d'exécution
  ansible.builtin.command: docker ps
  register: docker_ps_output
  changed_when: false
  become: yes

- name: Afficher les conteneurs actifs
  ansible.builtin.debug:
    msg: "{{ docker_ps_output.stdout_lines }}"
